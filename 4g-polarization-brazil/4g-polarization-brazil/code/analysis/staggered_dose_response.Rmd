---
title: "Staggered_dose_response"
author: "Fabio de Medeiros"
date: "2025-12-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 7,
  dpi = 300
)
```

```{r clean_env, echo=TRUE}
rm(list = ls())
gc()
```

# Packages

```{r}
library(tidyverse)
library(did)
library(fixest)
library(stats)
```

# Carregar dados

```{r load_data}
dados <- read_csv("painel_com_intensidade_4g.csv",
                  col_types = cols(codigo_tse = col_character()))
```

# 1. PREPARAR DADOS: Criar gname baseado em primeiro ano com 4G

```{r}
# Mapeamento codigo_tse â†’ id numÃ©rico
mapeamento_id <- dados %>%
  distinct(codigo_tse) %>%
  arrange(codigo_tse) %>%
  mutate(id = row_number())

dados <- dados %>%
  left_join(mapeamento_id, by = "codigo_tse")
```


```{r preparing_data}
# Identificar primeiro ano que municÃ­pio recebeu 4G

dados <- dados %>%
  group_by(codigo_tse) %>%
  arrange(codigo_tse, ano) %>%
  mutate(
    # Primeiro ano com 4G
    primeiro_ano_4g = ifelse(any(total_erbs_4g > 0), 
                             min(ano[total_erbs_4g > 0]), 
                             0),
    
    # Gname para CS (NA para never-treated)
    gname = ifelse(primeiro_ano_4g == 0, NA, primeiro_ano_4g)
  ) %>%
  ungroup()


# Verificar distribuiÃ§Ã£o de cohort
cat("ðŸ“Š DISTRIBUIÃ‡ÃƒO DOS COHORTS:\n\n")
cohort_dist <- dados %>%
  distinct(codigo_tse, gname) %>%
  group_by(gname) %>%
  summarise(n_municipios = n()) %>%
  arrange(gname)

print(cohort_dist)
cat("\n")

# EstatÃ­sticas de intensidade POR COHORT
cat("ðŸ“Š INTENSIDADE MÃ‰DIA POR COHORT (no ano de adoÃ§Ã£o):\n\n")
intensidade_cohort <- dados %>%
  filter(!is.na(gname), ano == gname) %>%
  group_by(gname) %>%
  summarise(
    n = n(),
    media_erbs = mean(erbs_per_1000hab, na.rm = TRUE),
    mediana_erbs = median(erbs_per_1000hab, na.rm = TRUE),
    min_erbs = min(erbs_per_1000hab, na.rm = TRUE),
    max_erbs = max(erbs_per_1000hab, na.rm = TRUE)
  )

print(intensidade_cohort)
```

# 2. MODELO DOSE-RESPONSE STAGGERED: Intensidade como covariada

```{r cs_dose_staggered}

cat("EspecificaÃ§Ã£o:\n")
cat("  xformla = ~ anos_3g + erbs_per_1000hab\n")
cat("  control_group = notyettreated\n")
cat("  est_method = reg (regressÃ£o)\n\n")

# Estimar
cs_dose_staggered <- att_gt(
  yname = "esteban_ray",
  tname = "ano",
  idname = "id",
  gname = "gname",
  
  # DOSE-RESPONSE: intensidade como covariada contÃ­nua
  xformla = ~ anos_3g + erbs_per_1000hab,
  
  data = dados,
  control_group = "notyettreated",
  est_method = "reg",  # Importante para covariadas contÃ­nuas
  base_period = "universal",
  anticipation = 0,
  print_details = FALSE,
  panel = FALSE
)

# AgregaÃ§Ã£o simples
agg_dose <- aggte(cs_dose_staggered, type = "simple")

cat("âœ… EstimaÃ§Ã£o concluÃ­da\n\n")
cat("RESULTADO - ATT MÃ‰DIO:\n")
cat(sprintf("  ATT: %.6f\n", agg_dose$overall.att))
cat(sprintf("  SE:  %.6f\n", agg_dose$overall.se))
cat(sprintf("  P-valor: %.4f\n", 
            2 * pnorm(-abs(agg_dose$overall.att / agg_dose$overall.se))))
cat("\n")

# Event study dinÃ¢mico
cat("Estimando event study dinÃ¢mico...\n")
agg_dose_dynamic <- aggte(cs_dose_staggered, type = "dynamic")

```

